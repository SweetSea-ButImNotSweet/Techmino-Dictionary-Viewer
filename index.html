<!DOCTYPE html>
<!-- THAY ƒê·ªîI: B·ªè class "dark" v√¨ style t·ªëi gi·ªù l√† m·∫∑c ƒë·ªãnh trong CSS -->
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Kh√≥a Dark Reader ƒë·ªÉ kh√¥ng t·ª± ƒë·ªông √°p d·ª•ng giao di·ªán t·ªëi (v√¨ trang ƒë√£ c√≥ s·∫µn) -->
    <meta name="darkreader-lock">
    <title>Zictionary</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* T·∫£i font ch·ªØ t√πy ch·ªânh t·ª´ GitHub CDN */
        @font-face {
            font-family: 'Proportional';
            src: url('https://cdn.jsdelivr.net/gh/26F-Studio/Techmino@main/parts/fonts/proportional.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap; /* ƒê·∫£m b·∫£o font ƒë∆∞·ª£c hi·ªÉn th·ªã ngay c·∫£ khi t·∫£i ch·∫≠m */
        }

        :root {
            /* THAY ƒê·ªîI: Ch·ªâ ƒë·ªãnh r√µ color-scheme l√† dark ƒë·ªÉ tr√¨nh duy·ªát hi·ªÉu ƒë√¢y l√† giao di·ªán t·ªëi */
            color-scheme: dark;
            background-color: black;

            /* Bi·∫øn m√†u cho giao di·ªán t·ªëi */
            --dark-bg-main: rgba(26, 26, 26, 0.75);
            --dark-bg-input: rgba(34, 34, 34, 0.75);
            --dark-bg-hover: rgba(34, 34, 34, 0.75);
            --dark-bg-active: rgba(10, 10, 10, 0.75);
            --dark-border-color: #2f855a;
            --dark-text-primary: #e2e8f0;
            --dark-text-secondary: #cbd5e0;
            --dark-text-green: #48bb78;
            --dark-text-active: #81e6d9;
        }

        body {
            font-family: 'Proportional', 'Inter', sans-serif;
            background-color: transparent; /* ƒê·ªÉ n·ªÅn canvas c√≥ th·ªÉ nh√¨n th·∫•y */
            color: var(--dark-text-primary);
        }

        /* CSS cho canvas n·ªÅn sao, ƒë·∫£m b·∫£o n√≥ n·∫±m sau v√† to√†n m√†n h√¨nh */
        canvas#background {
            position: fixed;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
        }

        /* * T·ªêI ∆ØU H√ìA CH·ªêNG-FLASH:
         * C√°c style cho giao di·ªán t·ªëi ƒë∆∞·ª£c √°p d·ª•ng tr·ª±c ti·∫øp v√† m·∫∑c ƒë·ªãnh.
         * D√πng `!important` ƒë·ªÉ ƒë·∫£m b·∫£o c√°c style n√†y ghi ƒë√® l√™n c√°c class c·ªßa Tailwind
         * ngay c·∫£ sau khi Tailwind JIT ƒë√£ ch·∫°y, ngƒÉn ch·∫∑n hi·ªán t∆∞·ª£ng "flash".
        */
        .bg-white { background-color: var(--dark-bg-main) !important; }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3) !important; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.6), 0 4px 6px -2px rgba(0, 0, 0, 0.2) !important; }

        .text-green-600 { color: var(--dark-text-green) !important; }

        .bg-green-50 { background-color: var(--dark-bg-input) !important; }
        .border-green-300 { border-color: var(--dark-border-color) !important; }
        .focus\:ring-green-400:focus { --tw-ring-color: var(--dark-border-color) !important; }
        .text-green-700 { color: var(--dark-text-primary) !important; }
        .placeholder-green-400::placeholder { color: #d0d0d0 !important; }
        svg.text-green-400 { color: var(--dark-text-green) !important; }

        .border-green-200 { border-color: var(--dark-border-color) !important; }
        .hover\:bg-green-100:hover { background-color: var(--dark-bg-hover) !important; }
        .active\:bg-green-200:active { background-color: var(--dark-bg-active) !important; }

        .bg-green-100 { background-color: var(--dark-bg-active) !important; }
        .text-green-800 { color: var(--dark-text-active) !important; }

        .text-gray-700 { color: var(--dark-text-secondary) !important; }

        .bg-green-500 { background-color: var(--dark-border-color) !important; }
        .hover\:bg-green-600:hover { background-color: #276749 !important; }

        /* C·∫ßn ch·ªâ ƒë·ªãnh r√µ h∆°n ƒë·ªÉ ghi ƒë√® Tailwind */
        .p-4.bg-gray-100 { background-color: var(--dark-bg-input) !important; }
        .border-gray-200 { border-color: var(--dark-border-color) !important; }

        /* Thanh cu·ªôn cho giao di·ªán t·ªëi */
        ::-webkit-scrollbar-track { background: #222; }
        ::-webkit-scrollbar-thumb { background-color: #1a1a1a; border: 2px solid #222; }
        ::-webkit-scrollbar-thumb:hover { background-color: #0a0a0a; }
    </style>
</head>
<body>
    <!-- Canvas cho n·ªÅn sao -->
    <canvas id="background"></canvas>

    <div class="h-screen flex flex-col">
        <!-- Header section -->
        <header class="p-4 bg-white shadow-md rounded-b-xl sticky top-0 z-10">
            <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                <h1 class="text-3xl font-extrabold text-green-600 whitespace-nowrap">Zictionary <span class="text-xl">üåø</span></h1>
                <div class="relative w-full md:max-w-md">
                    <input
                        type="text"
                        id="search-input"
                        placeholder="T√¨m ki·∫øm"
                        class="w-full p-3 pl-10 pr-4 rounded-full border-2 border-green-300 focus:ring-2 focus:ring-green-400 bg-green-50 text-green-700 placeholder-green-400 transition duration-300 shadow-sm"
                    >
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400" fill="currentColor" viewBox="0 0 20 20" width="20" height="20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <select id="language-select" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 transition duration-300 focus:outline-none focus:ring-2 focus:ring-green-400">
                    <!-- C√°c t√πy ch·ªçn ng√¥n ng·ªØ s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                </select>
            </div>
        </header>

        <!-- Main content section -->
        <main class="flex-1 flex flex-col md:flex-row p-4 gap-4 container mx-auto overflow-hidden">
            <aside class="w-full md:w-1/3 lg:w-1/4 bg-white p-4 rounded-xl shadow-lg flex-shrink-0 h-full overflow-y-auto">
                <h2 id="keywords-title" class="text-2xl font-semibold text-green-600 mb-4 pb-2 border-b-2 border-green-200">T·ª´ kh√≥a üìö</h2>
                <div id="keyword-list" class="space-y-2">
                    <div id="loading-indicator" class="text-center text-green-500 dark:text-green-400 font-medium py-4">
                        ƒêang t·∫£i Zictionary... ‚è≥
                    </div>
                </div>
            </aside>

            <section id="content-display" class="flex-1 bg-white p-6 rounded-xl shadow-lg h-full overflow-y-auto">
                <h2 id="content-title" class="text-3xl font-bold text-green-700 mb-4 pb-2 border-b-2 border-green-300">Ch√†o m·ª´ng ƒë·∫øn v·ªõi Zictionary! üå±</h2>
                <div id="content-body" class="text-gray-700 leading-relaxed text-lg">
                    <p>
                        H√£y ch·ªçn m·ªôt t·ª´ kh√≥a t·ª´ danh s√°ch b√™n tr√°i ho·∫∑c s·ª≠ d·ª•ng thanh t√¨m ki·∫øm ƒë·ªÉ kh√°m kh√°m ph√° nh·ªØng ƒëi·ªÅu th√∫ v·ªã nh√©! Em hy v·ªçng anh Sea s·∫Ω th√≠ch Zictionary phi√™n b·∫£n xanh l√° n√†y! N√≥ s·∫Ω gi√∫p anh Sea t√¨m ki·∫øm m·ªçi th·ª© m·ªôt c√°ch d·ªÖ d√†ng v√† nhanh ch√≥ng ƒë√≥. N·∫øu c√≥ b·∫•t k·ª≥ c√¢u h·ªèi n√†o, anh Sea c·ª© h·ªèi em nh√©! üíñ
                    </p>
                </div>
                <div id="link-container" class="mt-6 hidden">
                    <a id="content-link" href="#" target="_blank" class="inline-flex items-center px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 transition duration-300">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0l-7 7m7-7v7"></path></svg>
                        <span id="open-link-text">M·ªü li√™n k·∫øt</span>
                    </a>
                </div>

                <div id="ai-feature-section" class="mt-8 pt-4 border-t-2 border-green-200 dark:border-green-700">
                    <h3 id="ai-section-title" class="text-2xl font-semibold text-green-600 dark:text-green-500 mb-4">Th√¥ng tin m·ªü r·ªông ‚ú®</h3>
                    <button id="generate-insight-btn" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path></svg>
                        <span id="generate-insight-text">T·∫°o th√¥ng tin m·ªü r·ªông</span>
                    </button>
                    <div id="insight-output" class="mt-4 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hidden">
                        <p id="insight-text" class="whitespace-pre-wrap"></p>
                        <div id="insight-loading" class="text-center py-2 hidden">ƒêang t·∫°o th√¥ng tin... üß†</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- T·∫£i script n·ªÅn sao -->
    <script src="https://cdn.jsdelivr.net/gh/techmino-hub/techmino-hub-source-code@ef75e52d922195c1442d9bea55895f93e9139d2e/public/scripts/background.min.js"></script>

    <script>
        (function() {
            // C·∫•u h√¨nh v√† d·ªØ li·ªáu tƒ©nh
            const config = {
                enableAiManually: true, // B·∫≠t/t·∫Øt t√≠nh nƒÉng AI
                languages: [
                    { code: 'en', name: 'English' },
                    { code: 'vi', name: 'Ti·∫øng Vi·ªát' },
                    { code: 'ja', name: 'Êó•Êú¨Ë™û' },
                    { code: 'zh', name: '‰∏≠Êñá' }
                ],
                getDictionaryUrl: (langCode) => `https://cdn.jsdelivr.net/gh/SweetSea-ButImNotSweet/Techmino-Dictionary-Viewer@main/dict/${langCode}.json`
            };

            const translations = {
                'search_placeholder': { 'en': 'Search', 'vi': 'T√¨m ki·∫øm', 'ja': 'Ê§úÁ¥¢', 'zh': 'ÊêúÁ¥¢' },
                'keywords_title': { 'en': 'Keywords üìö', 'vi': 'T·ª´ kh√≥a üìö', 'ja': '„Ç≠„Éº„ÉØ„Éº„Éâ üìö', 'zh': 'ÂÖ≥ÈîÆËØç üìö' },
                'welcome_title': { 'en': 'Thank you for reading Zictionary.', 'vi': 'C·∫£m ∆°n b·∫°n ƒë√£ t√¨m ƒë·ªçc Zictionary.', 'ja': 'Zictionary„Çí„ÅîË¶ß„ÅÑ„Åü„Å†„Åç„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ', 'zh': 'ÊÑüË∞¢ÊÇ®ÈòÖËØªZictionary„ÄÇ' },
                'welcome_message': { 'en': 'Zictionary is being downloaded...', 'vi': 'Zictionary ƒëang ƒë∆∞·ª£c t·∫£i xu·ªëng...', 'ja': 'Zictionary„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ‰∏≠„Åß„Åô...', 'zh': 'ZictionaryÊ≠£Âú®‰∏ãËΩΩ...' },
                'open_link_button': { 'en': 'Open link', 'vi': 'M·ªü li√™n k·∫øt', 'ja': '„É™„É≥„ÇØ„ÇíÈñã„Åè', 'zh': 'ÊâìÂºÄÈìæÊé•' },
                'ai_section_title': { 'en': 'Extended Information ‚ú®', 'vi': 'Th√¥ng tin m·ªü r·ªông ‚ú®', 'ja': 'Êã°ÂºµÊÉÖÂ†± ‚ú®', 'zh': 'Êâ©Â±ï‰ø°ÊÅØ ‚ú®' },
                'generate_insight_button': { 'en': 'Generate Insight', 'vi': 'T·∫°o th√¥ng tin m·ªü r·ªông', 'ja': 'Ê¥ûÂØü„ÇíÁîüÊàê', 'zh': 'ÁîüÊàêËßÅËß£' },
                'loading_dictionary': { 'en': 'Loading Zictionary... ‚è≥', 'vi': 'ƒêang t·∫£i Zictionary... ‚è≥', 'ja': 'Zictionary„ÇíË™≠„ÅøËæº„Åø‰∏≠... ‚è≥', 'zh': 'Ê≠£Âú®Âä†ËΩΩZictionary... ‚è≥' },
                'generating_insight': { 'en': 'Generating insight... üß†', 'vi': 'ƒêang t·∫°o th√¥ng tin... üß†', 'ja': 'Ê¥ûÂØü„ÇíÁîüÊàê‰∏≠... üß†', 'zh': 'Ê≠£Âú®ÁîüÊàêËßÅËß£... üß†' },
                'ai_disabled': { 'en': 'AI feature is currently disabled.', 'vi': 'T√≠nh nƒÉng AI hi·ªán ƒëang t·∫Øt.', 'ja': 'AIÊ©üËÉΩ„ÅØÁèæÂú®ÁÑ°Âäπ„Åß„Åô„ÄÇ', 'zh': 'AIÂäüËÉΩÂΩìÂâçÂ∑≤Á¶ÅÁî®„ÄÇ' },
                'ai_select_keyword': { 'en': 'Please select a keyword to generate extended information.', 'vi': 'Vui l√≤ng ch·ªçn m·ªôt t·ª´ kh√≥a ƒë·ªÉ t·∫°o th√¥ng tin m·ªü r·ªông.', 'ja': 'Êã°ÂºµÊÉÖÂ†±„ÇíÁîüÊàê„Åô„Çã„Å´„ÅØ„ÄÅ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'zh': 'ËØ∑ÈÄâÊã©‰∏Ä‰∏™ÂÖ≥ÈîÆËØç‰ª•ÁîüÊàêÊâ©Â±ï‰ø°ÊÅØ„ÄÇ' },
                'ai_generation_failed': { 'en': 'Sorry, unable to generate extended information.', 'vi': 'R·∫•t ti·∫øc, kh√¥ng th·ªÉ t·∫°o th√¥ng tin m·ªü r·ªông l√∫c n√†y.', 'ja': 'Áî≥„ÅóË®≥„ÅÇ„Çä„Åæ„Åõ„Çì„Åå„ÄÅÁèæÂú®Êã°ÂºµÊÉÖÂ†±„ÇíÁîüÊàê„Åß„Åç„Åæ„Åõ„Çì„ÄÇ', 'zh': 'Êä±Ê≠âÔºåÊöÇÊó∂Êó†Ê≥ïÁîüÊàêÊâ©Â±ï‰ø°ÊÅØ„ÄÇ' },
                'ai_connection_error': { 'en': 'An error occurred while connecting to the Gemini API.', 'vi': 'ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi v·ªõi Gemini API.', 'ja': 'Gemini API„Å∏„ÅÆÊé•Á∂ö‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'zh': 'ËøûÊé•Âà∞Gemini APIÊó∂ÂèëÁîüÈîôËØØ„ÄÇ' },
                'error_loading_dictionary_title': { 'en': 'Failed to load dictionary üò≠', 'vi': 'Kh√¥ng t·∫£i ƒë∆∞·ª£c t·ª´ ƒëi·ªÉn üò≠', 'ja': 'ËæûÊõ∏„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü üò≠', 'zh': 'Â≠óÂÖ∏Âä†ËΩΩÂ§±Ë¥• üò≠' },
                'error_loading_dictionary_message': { 'en': 'Zictionary failed to load data.', 'vi': 'Zictionary ch∆∞a t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu r·ªìi.', 'ja': 'Zictionary„ÅÆ„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'zh': 'ZictionaryÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•„ÄÇ' },
                'keyword_not_found_title': { 'en': 'Keyword not found', 'vi': 'Kh√¥ng t√¨m th·∫•y t·ª´ kh√≥a', 'ja': '„Ç≠„Éº„ÉØ„Éº„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 'zh': 'Êú™ÊâæÂà∞ÂÖ≥ÈîÆËØç' },
                'keyword_not_found_message': { 'en': 'No matching keywords found.', 'vi': 'Kh√¥ng t√¨m th·∫•y t·ª´ kh√≥a n√†o ph√π h·ª£p.', 'ja': '‰∏ÄËá¥„Åô„Çã„Ç≠„Éº„ÉØ„Éº„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ', 'zh': 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÂÖ≥ÈîÆËØç„ÄÇ' },
                'error_loading_dictionary_list_item': { 'en': 'Error loading dictionary', 'vi': 'L·ªói t·∫£i t·ª´ ƒëi·ªÉn', 'ja': 'ËæûÊõ∏Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº', 'zh': 'Â≠óÂÖ∏Âä†ËΩΩ„Ç®„É©„Éº' },
                'ai_prompt_base': { 'en': "Based on the term '${termName}' and its definition: '${termDefinition}', provide a short paragraph (maximum 3 sentences) about an interesting fact, a practical application, or a broader context related to this term in the field of puzzle games or technology in general. Do not just rephrase the definition.", 'vi': "D·ª±a v√†o thu·∫≠t ng·ªØ '${termName}' v√† ƒë·ªãnh nghƒ©a c·ªßa n√≥: '${termDefinition}', h√£y cung c·∫•p m·ªôt ƒëo·∫°n vƒÉn ng·∫Øn (t·ªëi ƒëa 3 c√¢u) v·ªÅ m·ªôt th√¥ng tin th√∫ v·ªã, m·ªôt ·ª©ng d·ª•ng th·ª±c t·∫ø, ho·∫∑c m·ªôt b·ªëi c·∫£nh r·ªông h∆°n li√™n quan ƒë·∫øn thu·∫≠t ng·ªØ n√†y trong lƒ©nh v·ª±c game x·∫øp g·∫°ch ho·∫∑c c√¥ng ngh·ªá n√≥i chung. ƒê·ª´ng ch·ªâ di·ªÖn gi·∫£i l·∫°i ƒë·ªãnh nghƒ©a.", 'ja': "Áî®Ë™û„Äå${termName}„Äç„Å®„Åù„ÅÆÂÆöÁæ©„Äå${termDefinition}„Äç„Å´Âü∫„Å•„ÅÑ„Å¶„ÄÅ„Éë„Ç∫„É´„Ç≤„Éº„É†„ÇÑ‰∏ÄËà¨ÁöÑ„Å™„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„ÅÆÂàÜÈáé„Å´„Åä„Åë„Çã„Åì„ÅÆÁî®Ë™û„Å´Èñ¢ÈÄ£„Åô„ÇãËààÂë≥Ê∑±„ÅÑ‰∫ãÂÆü„ÄÅÂÆüÁî®ÁöÑ„Å™ÂøúÁî®„ÄÅ„Åæ„Åü„ÅØ„Çà„ÇäÂ∫É„ÅÑÊñáËÑà„Å´„Å§„ÅÑ„Å¶Áü≠„ÅÑÊÆµËêΩÔºàÊúÄÂ§ß3ÊñáÔºâ„ÇíÊèê‰æõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂÆöÁæ©„ÇíË®Ä„ÅÑÊèõ„Åà„Çã„Å†„Åë„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì", 'zh': "Ê†πÊçÆÊúØËØ≠‚Äú${termName}‚ÄùÂèäÂÖ∂ÂÆö‰πâÔºö‚Äú${termDefinition}‚ÄùÔºåÊèê‰æõ‰∏Ä‰∏™ÂÖ≥‰∫éËØ•ÊúØËØ≠Âú®ÁõäÊô∫Ê∏∏ÊàèÊàñ‰∏ÄËà¨ÊäÄÊúØÈ¢ÜÂüü‰∏≠Áõ∏ÂÖ≥ÁöÑÊúâË∂£‰∫ãÂÆû„ÄÅÂÆûÈôÖÂ∫îÁî®ÊàñÊõ¥ÂπøÊ≥õËÉåÊôØÁöÑÁÆÄÁü≠ÊÆµËêΩÔºàÊúÄÂ§ö3Âè•ËØùÔºâ„ÄÇ" }
            };

            const app = {
                state: {
                    dictionary: {},
                    filteredData: [],
                    selectedKeywordEl: null,
                    currentEntry: null,
                    currentKeyword: null,
                    currentLanguage: null,
                },
                elements: {},
                methods: {
                    init() {
                        app.state.currentLanguage = app.methods.getInitialLanguage();
                        app.methods.cacheDomElements();
                        app.methods.setupAiFeature();
                        app.methods.setupLanguageSelector();
                        app.methods.bindEvents();
                        app.methods.updateUIText();
                        app.methods.loadDictionaryData();
                    },

                    getInitialLanguage() {
                        const savedLang = localStorage.getItem('language');
                        const supportedLangs = config.languages.map(l => l.code);
                        if (savedLang && supportedLangs.includes(savedLang)) {
                            return savedLang;
                        }
                        const browserLang = navigator.language.split('-')[0];
                        if (supportedLangs.includes(browserLang)) {
                            return browserLang;
                        }
                        return 'en';
                    },

                    cacheDomElements() {
                        app.elements = {
                            keywordList: document.getElementById('keyword-list'),
                            contentTitle: document.getElementById('content-title'),
                            contentBody: document.getElementById('content-body'),
                            searchInput: document.getElementById('search-input'),
                            openLinkText: document.getElementById('open-link-text'),
                            contentLink: document.getElementById('content-link'),
                            linkContainer: document.getElementById('link-container'),
                            loadingIndicator: document.getElementById('loading-indicator'),
                            aiFeatureSection: document.getElementById('ai-feature-section'),
                            generateInsightBtn: document.getElementById('generate-insight-btn'),
                            generateInsightText: document.getElementById('generate-insight-text'),
                            insightOutput: document.getElementById('insight-output'),
                            insightText: document.getElementById('insight-text'),
                            insightLoading: document.getElementById('insight-loading'),
                            languageSelect: document.getElementById('language-select'),
                            keywordsTitle: document.getElementById('keywords-title'),
                            aiSectionTitle: document.getElementById('ai-section-title'),
                        };
                    },

                    bindEvents() {
                        app.elements.searchInput.addEventListener('input', (e) => {
                            app.methods.filterAndRender(e.target.value);
                        });
                        app.elements.languageSelect.addEventListener('change', (e) => {
                            app.methods.changeLanguage(e.target.value);
                        });
                        app.elements.generateInsightBtn.addEventListener('click', app.methods.handleGenerateInsight);
                    },

                    setupAiFeature() {
                        if (config.enableAiManually) {
                            app.elements.aiFeatureSection.classList.remove('hidden');
                        } else {
                            app.elements.aiFeatureSection.classList.add('hidden');
                        }
                    },

                    setupLanguageSelector() {
                        config.languages.forEach(lang => {
                            const option = document.createElement('option');
                            option.value = lang.code;
                            option.textContent = lang.name;
                            app.elements.languageSelect.appendChild(option);
                        });
                        app.elements.languageSelect.value = app.state.currentLanguage;
                    },

                    changeLanguage(langCode) {
                        app.state.currentLanguage = langCode;
                        localStorage.setItem('language', langCode);
                        app.state.currentKeyword = null;
                        app.methods.updateUIText();
                        app.methods.loadDictionaryData();
                    },

                    updateUIText() {
                        const lang = app.state.currentLanguage;
                        app.elements.searchInput.placeholder = translations.search_placeholder[lang];
                        app.elements.keywordsTitle.textContent = translations.keywords_title[lang];
                        app.elements.openLinkText.textContent = translations.open_link_button[lang];
                        app.elements.aiSectionTitle.textContent = translations.ai_section_title[lang];
                        app.elements.generateInsightText.textContent = translations.generate_insight_button[lang];
                        app.elements.loadingIndicator.textContent = translations.loading_dictionary[lang];
                        app.elements.insightLoading.textContent = translations.generating_insight[lang];
                        if (!app.state.currentKeyword) {
                            app.elements.contentTitle.textContent = translations.welcome_title[lang];
                            app.elements.contentBody.innerHTML = `<p>${translations.welcome_message[lang]}</p>`;
                        }
                    },

                    async loadDictionaryData() {
                        app.elements.loadingIndicator.classList.remove('hidden');
                        app.elements.keywordList.innerHTML = '';
                        try {
                            const response = await fetch(config.getDictionaryUrl(app.state.currentLanguage));
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            const rawData = await response.json();

                            app.state.dictionary = {};
                            rawData.forEach(([name, keyword, category, content, link], index) => {
                                if ((content && (content.includes("{{FNNS:") || content.includes("{{FNNS|"))) ||
                                    (name && (name.includes("{{FNNS:") || name.includes("{{FNNS|")))) return;
                                app.state.dictionary[keyword] = { name, keyword, category, content, link, originalIndex: index };
                            });

                            app.methods.filterAndRender('');
                        } catch (error) {
                            console.error("Error loading dictionary:", error);
                            app.methods.displayContent("error_loading_dictionary");
                        } finally {
                            app.elements.loadingIndicator.classList.add('hidden');
                        }
                    },

                    filterAndRender(searchTerm) {
                        const lowerSearchTerm = searchTerm.toLowerCase().trim();
                        if (lowerSearchTerm === '') {
                             app.state.filteredData = Object.values(app.state.dictionary).sort((a,b) => a.originalIndex - b.originalIndex);
                        } else {
                            const exactMatches = [];
                            const otherMatches = [];
                            Object.values(app.state.dictionary).forEach(entry => {
                                if (entry.keyword.trim() === "" && lowerSearchTerm !== "") return;
                                const lowerName = entry.name.toLowerCase();
                                const lowerKeyword = entry.keyword.toLowerCase();
                                if (lowerName === lowerSearchTerm) exactMatches.push(entry);
                                else if (lowerName.includes(lowerSearchTerm) || lowerKeyword.includes(lowerSearchTerm)) otherMatches.push(entry);
                            });
                            exactMatches.sort((a, b) => a.originalIndex - b.originalIndex);
                            otherMatches.sort((a, b) => a.originalIndex - b.originalIndex);
                            app.state.filteredData = [...exactMatches, ...otherMatches];
                        }
                        app.methods.renderKeywords();
                    },

                    renderKeywords() {
                        app.elements.keywordList.innerHTML = '';
                        if (app.state.filteredData.length === 0) {
                            const noResultDiv = document.createElement('div');
                            noResultDiv.className = 'p-1.5 rounded-lg text-gray-500 italic';
                            noResultDiv.innerHTML = translations.keyword_not_found_message[app.state.currentLanguage];
                            app.elements.keywordList.appendChild(noResultDiv);
                            app.methods.displayContent('');
                            return;
                        }

                        const ul = document.createElement('ul');
                        ul.className = 'space-y-0.5';
                        app.state.filteredData.forEach(entry => {
                            const li = document.createElement('li');
                            li.className = 'p-1 rounded-md hover:bg-green-100 cursor-pointer transition duration-200 text-sm font-medium active:bg-green-200';
                            li.textContent = entry.name;
                            li.dataset.keyword = entry.keyword;
                            li.style.color = app.methods.getCategoryColor(entry.category);
                            li.addEventListener('click', () => app.methods.displayContent(entry.keyword));
                            ul.appendChild(li);
                        });
                        app.elements.keywordList.appendChild(ul);

                        if (!app.state.currentKeyword || !app.state.filteredData.some(e => e.keyword === app.state.currentKeyword)) {
                            app.methods.displayContent(app.state.filteredData[0].keyword);
                        }
                    },

                    displayContent(keyword) {
                        app.state.currentKeyword = keyword;
                        const { elements, state } = app;

                        if (state.selectedKeywordEl) {
                            state.selectedKeywordEl.classList.remove('bg-green-100', 'text-green-800', 'font-bold', 'shadow-sm');
                            const prevEntry = state.dictionary[state.selectedKeywordEl.dataset.keyword];
                            if(prevEntry) state.selectedKeywordEl.style.color = app.methods.getCategoryColor(prevEntry.category);
                        }

                        state.currentEntry = state.dictionary[keyword];
                        elements.linkContainer.classList.add('hidden');
                        elements.insightOutput.classList.add('hidden');
                        elements.generateInsightBtn.classList.add('hidden');

                        const lang = state.currentLanguage;
                        if (state.currentEntry) {
                            elements.contentTitle.textContent = state.currentEntry.name;
                            elements.contentBody.innerHTML = `<p class="whitespace-pre-wrap">${state.currentEntry.content}</p>`;
                            if (state.currentEntry.link) {
                                elements.contentLink.href = state.currentEntry.link;
                                elements.linkContainer.classList.remove('hidden');
                            }
                            if (config.enableAiManually) {
                                elements.generateInsightBtn.classList.remove('hidden');
                            }
                        } else if (keyword === "error_loading_dictionary") {
                            elements.contentTitle.textContent = translations.error_loading_dictionary_title[lang];
                            elements.contentBody.innerHTML = `<p>${translations.error_loading_dictionary_message[lang]}</p>`;
                        } else {
                            elements.contentTitle.textContent = translations.keyword_not_found_title[lang];
                            elements.contentBody.innerHTML = `<p>${translations.keyword_not_found_message[lang]}</p>`;
                        }

                        const newSelectedEl = document.querySelector(`#keyword-list li[data-keyword="${keyword}"]`);
                        if (newSelectedEl) {
                            newSelectedEl.classList.add('bg-green-100', 'text-green-800', 'font-bold', 'shadow-sm');
                            newSelectedEl.style.color = '';
                            state.selectedKeywordEl = newSelectedEl;
                        }
                    },

                    async handleGenerateInsight() {
                        const { elements, state } = app;
                        const lang = state.currentLanguage;

                        if (!state.currentEntry) {
                            elements.insightText.textContent = translations.ai_select_keyword[lang];
                            elements.insightOutput.classList.remove('hidden');
                            return;
                        }

                        elements.insightOutput.classList.remove('hidden');
                        elements.insightText.textContent = "";
                        elements.insightLoading.classList.remove('hidden');
                        elements.generateInsightBtn.disabled = true;

                        const promptTemplate = translations.ai_prompt_base[lang];
                        const prompt = promptTemplate
                            .replace('${termName}', state.currentEntry.name)
                            .replace('${termDefinition}', state.currentEntry.content);

                        try {
                            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                            const apiKey = ""; // Canvas s·∫Ω t·ª± cung c·∫•p
                            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            const result = await response.json();

                            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                                elements.insightText.textContent = result.candidates[0].content.parts[0].text;
                            } else {
                                throw new Error("Invalid API response format");
                            }
                        } catch (error) {
                            elements.insightText.textContent = translations.ai_connection_error[lang];
                            console.error("Error calling Gemini API:", error);
                        } finally {
                            elements.insightLoading.classList.add('hidden');
                            elements.generateInsightBtn.disabled = false;
                        }
                    },

                    getCategoryColor(category) {
                        const colorMap = { 'help': 'yellow', 'org': 'fire', 'game': 'cyan', 'term': 'red', 'setup': 'yellow', 'pattern': 'jade', 'command': 'navy', 'english': 'blue', 'name': 'violet' };
                        const hsvMap = { 'red': [0.00, 1.00, 1.00], 'fire': [0.04, 1.00, 0.95], 'orange': [0.09, 1.00, 0.95], 'yellow': [0.15, 0.98, 0.95], 'lime': [0.20, 0.95, 0.40], 'jade': [0.25, 0.95, 0.35], 'green': [0.33, 0.95, 0.30], 'aqua': [0.47, 0.90, 0.30], 'cyan': [0.53, 0.95, 0.40], 'navy': [0.56, 0.95, 0.50], 'sea': [0.61, 0.95, 0.50], 'blue': [0.64, 0.95, 0.45], 'violet': [0.74, 0.90, 0.40], 'purple': [0.80, 0.95, 0.40], 'magenta': [0.86, 0.95, 0.35], 'wine': [0.92, 0.95, 0.45], 'black': [0.00, 0.00, 0.00], 'white': [0.00, 0.00, 1.00] };

                        if (category === '') return 'rgb(255,255,255)';
                        const colorKey = colorMap[category] || 'gray';
                        let hsv = hsvMap[colorKey];
                        if (hsv) {
                            let [h, s, v] = hsv;
                            v = Math.max(v, 0.7);
                            let r, g, b, i = Math.floor(h * 6), f = h * 6 - i, p = v * (1 - s), q = v * (1 - f * s), t = v * (1 - (1 - f) * s);
                            switch (i % 6) { case 0: r = v, g = t, b = p; break; case 1: r = q, g = v, b = p; break; case 2: r = p, g = v, b = t; break; case 3: r = p, g = q, b = v; break; case 4: r = t, g = p, b = v; break; case 5: r = v, g = p, b = q; break; }
                            return `rgb(${Math.round(r*255)}, ${Math.round(g*255)}, ${Math.round(b*255)})`;
                        }
                        return 'inherit';
                    }
                }
            };

            document.addEventListener('DOMContentLoaded', app.methods.init);

        })();
    </script>
</body>
</html>