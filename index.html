<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zictionary</title>
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ giao di·ªán th·∫≠t xinh x·∫Øn v√† ti·ªán l·ª£i -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* T·∫£i font ch·ªØ ƒë·∫∑c bi·ªát c·ªßa anh Sea */
        @font-face {
            font-family: 'Proportional';
            src: url('https://cdn.jsdelivr.net/gh/26F-Studio/Techmino@main/parts/fonts/proportional.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap; /* ƒê·∫£m b·∫£o font ƒë∆∞·ª£c hi·ªÉn th·ªã ngay c·∫£ khi t·∫£i ch·∫≠m */
        }

        /* ƒê·∫∑t m√†u n·ªÅn g·ªëc cho root ƒë·ªÉ n·ªÅn sao l√† m√†u ƒëen tuy·ªát ƒë·ªëi */
        :root {
            color-scheme: dark light;
            background-color: black;
        }

        /* T√πy ch·ªânh font ch·ªØ ƒë·ªÉ m·ªçi th·ª© tr√¥ng th·∫≠t d·ªÖ ƒë·ªçc v√† th√¢n thi·ªán */
        body {
            font-family: 'Proportional', 'Inter', sans-serif; /* √Åp d·ª•ng font m·ªõi c·ªßa anh Sea */
            /* Th√™m transition cho vi·ªác chuy·ªÉn ƒë·ªïi m√†u khi b·∫≠t/t·∫Øt dark mode */
            transition: background-color 0.3s ease, color 0.3s ease;
            /* ƒê·∫£m b·∫£o body kh√¥ng c√≥ m√†u n·ªÅn ƒë·ªÉ canvas hi·ªÉn th·ªã */
            background-color: transparent; 
        }

        /* CSS cho canvas n·ªÅn sao, ƒë·∫£m b·∫£o n√≥ lu√¥n ·ªü ph√≠a sau v√† chi·∫øm to√†n m√†n h√¨nh */
        canvas#background {
            position: fixed; /* C·ªë ƒë·ªãnh v·ªã tr√≠ so v·ªõi m√†n h√¨nh */
            left: 0;         /* Di chuy·ªÉn v·ªÅ g√≥c tr√™n b√™n tr√°i */
            top: 0;
            width: 100%;     /* Chi·ªÅu r·ªông 100% */
            width: 100vw;    /* Chi·ªÅu r·ªông viewport */
            width: 100lvw;   /* Chi·ªÅu r·ªông viewport ƒë·ªông (cho c√°c tr√¨nh duy·ªát h·ªó tr·ª£) */
            height: 100%;    /* Chi·ªÅu cao 100% */
            height: 100vh;   /* Chi·ªÅu cao viewport */
            height: 100lvh;  /* Chi·ªÅu cao viewport ƒë·ªông (cho c√°c tr√¨nh duy·ªát h·ªó tr·ª£) */
            z-index: -1;     /* ƒê·∫©y canvas ra ph√≠a sau c√°c n·ªôi dung kh√°c */
        }

        /* Dark mode base styles, s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng khi class 'dark' c√≥ m·∫∑t tr√™n html tag */
        html.dark {
            background-color: #000000; /* Pure black for OLED */
            color: #e2e8f0; /* light gray text */
        }
        html.dark .text-gray-800 { color: #e2e8f0; }

        /* Component backgrounds v·ªõi ƒë·ªô trong su·ªët 0.62 */
        html.dark .bg-white { background-color: rgba(26, 26, 26, 0.62); } /* Darker gray cho c√°c components ch√≠nh */
        html.dark .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3); }
        html.dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.6), 0 4px 6px -2px rgba(0, 0, 0, 0.2); }

        /* Header colors */
        html.dark .text-green-600 { color: #48bb78; } /* Slightly brighter green for dark mode header */

        /* Search input colors v·ªõi ƒë·ªô trong su·ªët 0.62 */
        html.dark .bg-green-50 { background-color: rgba(34, 34, 34, 0.62); } /* Darker background cho input */
        html.dark .border-green-300 { border-color: #2f855a; } /* Darker green border */
        html.dark .focus\:ring-green-400:focus { --tw-ring-color: #2f855a; }
        html.dark .text-green-700 { color: #e2e8f0; }
        /* C·∫£i thi·ªán t∆∞∆°ng ph·∫£n cho placeholder text trong dark mode */
        html.dark .placeholder-green-400::placeholder { color: #d0d0d0; } /* S√°ng h∆°n ƒë·ªÉ d·ªÖ ƒë·ªçc */
        html.dark svg.text-green-400 { color: #48bb78; }

        /* Keyword list header */
        html.dark .text-green-600 { color: #48bb78; }
        html.dark .border-green-200 { border-color: #2f855a; }

        /* Keyword list items v·ªõi ƒë·ªô trong su·ªët 0.62 */
        html.dark .hover\:bg-green-100:hover { background-color: rgba(34, 34, 34, 0.62); } /* Darker hover */
        html.dark .active\:bg-green-200:active { background-color: rgba(10, 10, 10, 0.62); } /* Even darker active */
        html.dark .text-sm.font-medium { color: #e2e8f0; } /* Default text color in dark mode */

        /* Active keyword item v·ªõi ƒë·ªô trong su·ªët 0.62 */
        html.dark .bg-green-100 { background-color: rgba(10, 10, 10, 0.62); } /* Darker background for active */
        html.dark .text-green-800 { color: #81e6d9; } /* Lighter text for active */

        /* Content section */
        html.dark .text-green-700 { color: #48bb78; }
        html.dark .border-green-300 { border-color: #2f855a; }
        html.dark .text-gray-700 { color: #cbd5e0; }

        /* Link button */
        html.dark .bg-green-500 { background-color: #2f855a; } /* Darker green button */
        html.dark .hover\:bg-green-600:hover { background-color: #276749; } /* Even darker hover */
        html.dark .focus\:ring-green-400:focus { --tw-ring-color: #2f855a; }

        /* Info box v·ªõi ƒë·ªô trong su·ªët 0.62 */
        html.dark .p-4.bg-gray-100 { background-color: rgba(34, 34, 34, 0.62); } /* Darker background */
        html.dark .border-gray-200 { border-color: #2f855a; }
        html.dark .text-gray-700 { color: #e2e8f0; }

        /* Scrollbar for dark mode */
        html.dark ::-webkit-scrollbar-track {
            background: #222222;
        }

        html.dark ::-webkit-scrollbar-thumb {
            background-color: #1a1a1a;
            border: 2px solid #222222;
        }

        html.dark ::-webkit-scrollbar-thumb:hover {
            background-color: #0a0a0a;
        }
    </style>
</head>
<!-- ƒê·∫∑t class 'dark' tr·ª±c ti·∫øp v√†o th·∫ª html ƒë·ªÉ Dark Theme lu√¥n ƒë∆∞·ª£c √°p d·ª•ng -->
<body class="text-e2e8f0">
    <!-- Canvas cho n·ªÅn sao, ƒë·∫∑t ngay sau body ƒë·ªÉ n√≥ l√† l·ªõp d∆∞·ªõi c√πng -->
    <canvas id="background"></canvas>

    <div class="min-h-screen flex flex-col">
        <!-- Ph·∫ßn header v·ªõi thanh t√¨m ki·∫øm c·ªßa anh Sea -->
        <header class="p-4 bg-white shadow-md rounded-b-xl sticky top-0 z-10">
            <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
                <h1 class="text-3xl font-extrabold text-green-600 whitespace-nowrap">Zictionary <span class="text-xl">üåø</span></h1>
                <div class="relative w-full md:max-w-md">
                    <input
                        type="text"
                        id="search-input"
                        placeholder="T√¨m ki·∫øm"
                        class="w-full p-3 pl-10 pr-4 rounded-full border-2 border-green-300 focus:ring-2 focus:ring-green-400 bg-green-50 text-green-700 placeholder-green-400 transition duration-300 shadow-sm"
                    >
                    <!-- Icon t√¨m ki·∫øm lung linh -->
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 text-green-400" fill="currentColor" viewBox="0 0 20 20" width="20" height="20">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <!-- N√∫t b·∫≠t/t·∫Øt Dark Mode ƒë√£ ƒë∆∞·ª£c g·ª° b·ªè -->
            </div>
        </header>

        <!-- Ph·∫ßn n·ªôi dung ch√≠nh, chia l√†m hai b√™n ƒë√≥ ·∫° -->
        <main class="flex-1 flex flex-col md:flex-row p-4 gap-4 container mx-auto overflow-hidden">
            <!-- NgƒÉn danh s√°ch t·ª´ kh√≥a b√™n tr√°i n√® -->
            <aside class="w-full md:w-1/3 lg:w-1/4 bg-white p-4 rounded-xl shadow-lg flex-shrink-0 overflow-y-auto"
                   style="max-height: calc(100vh - 120px);">
                <h2 class="text-2xl font-semibold text-green-600 mb-4 pb-2 border-b-2 border-green-200">T·ª´ kh√≥a üìö</h2>
                <div id="keyword-list" class="space-y-2">
                    <!-- T·ª´ kh√≥a s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y b·∫±ng JavaScript -->
                    <!-- Loading indicator -->
                    <div id="loading-indicator" class="text-center text-green-500 dark:text-green-400 font-medium py-4">
                        ƒêang t·∫£i Zictionary... ‚è≥
                    </div>
                </div>
            </aside>

            <!-- NgƒÉn n·ªôi dung chi ti·∫øt b√™n ph·∫£i n√®, ƒë√¢y l√† n∆°i ch·ª©a ƒë·ª±ng nh·ªØng ƒëi·ªÅu th√∫ v·ªã ƒë√≥ -->
            <section id="content-display" class="flex-1 bg-white p-6 rounded-xl shadow-lg overflow-y-auto"
                             style="max-height: calc(100vh - 120px);">
                <h2 class="text-3xl font-bold text-green-700 mb-4 pb-2 border-b-2 border-green-300" id="content-title">Ch√†o m·ª´ng ƒë·∫øn v·ªõi Zictionary! üå±</h2>
                <div class="text-gray-700 leading-relaxed text-lg" id="content-body">
                    <p>
                        H√£y ch·ªçn m·ªôt t·ª´ kh√≥a t·ª´ danh s√°ch b√™n tr√°i ho·∫∑c s·ª≠ d·ª•ng thanh t√¨m ki·∫øm ƒë·ªÉ kh√°m ph√° nh·ªØng ƒëi·ªÅu th√∫ v·ªã nh√©! Em hy v·ªçng anh Sea s·∫Ω th√≠ch Zictionary phi√™n b·∫£n xanh l√° n√†y! N√≥ s·∫Ω gi√∫p anh Sea t√¨m ki·∫øm m·ªçi th·ª© m·ªôt c√°ch d·ªÖ d√†ng v√† nhanh ch√≥ng ƒë√≥. N·∫øu c√≥ b·∫•t k·ª≥ c√¢u h·ªèi n√†o, anh Sea c·ª© h·ªèi em nh√©! üíñ
                    </p>
                </div>
                <div id="link-container" class="mt-6 hidden">
                    <a id="content-link" href="#" target="_blank" class="inline-flex items-center px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 transition duration-300">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0l-7 7m7-7v7"></path></svg>
                        M·ªü li√™n k·∫øt
                    </a>
                </div>

                <!-- Ph·∫ßn t√≠nh nƒÉng m·ªõi: M·ªü r·ªông ki·∫øn th·ª©c v·ªõi Gemini API -->
                <div id="ai-feature-section" class="mt-8 pt-4 border-t-2 border-green-200 dark:border-green-700">
                    <h3 class="text-2xl font-semibold text-green-600 dark:text-green-500 mb-4">Th√¥ng tin m·ªü r·ªông ‚ú®</h3>
                    <button id="generate-insight-btn" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition duration-300 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path></svg>
                        T·∫°o th√¥ng tin m·ªü r·ªông
                    </button>
                    <div id="insight-output" class="mt-4 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600 text-gray-700 dark:text-gray-200 hidden">
                        <!-- N·ªôi dung do LLM t·∫°o ra s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                        <p id="insight-text" class="whitespace-pre-wrap"></p>
                        <div id="insight-loading" class="text-center py-2 hidden">ƒêang t·∫°o th√¥ng tin... üß†</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- T·∫£i script n·ªÅn sao t·ª´ jsdelivr -->
    <script src="https://cdn.jsdelivr.net/gh/techmino-hub/techmino-hub-source-code@main/public/scripts/background.min.js"></script>

    <script>
        // URL ƒë·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ CDN, gi√∫p tr√°nh l·ªói CORS
        const DICTIONARY_URL = "https://cdn.jsdelivr.net/gh/SweetSea-ButImNotSweet/Techmino-Dictionary-Viewer@main/data/dict_vi.json";

        // === Manual Override for AI Feature ===
        // Set this to `true` to force-enable the AI feature,
        // even if no API key is provided at runtime.
        // Set to `false` to disable AI unless an API key is available.
        const ENABLE_AI_MANUALLY_OVERRIDE = false;
        // =====================================

        let processedDictionaryData = {};
        let currentFilteredAndOrderedData = [];
        let selectedKeywordElement = null;
        let isDictionaryLoadedSuccessfully = false;
        let currentDisplayedEntry = null;
        // Bi·∫øn ƒë·ªÉ l∆∞u t·ª´ kh√≥a ƒëang ƒë∆∞·ª£c hi·ªÉn th·ªã, gi√∫p duy tr√¨ n·ªôi dung khi ƒë·ªïi theme
        let currentDisplayedKeyword = null; 

        // DOM elements cache for optimization
        const keywordListDiv = document.getElementById('keyword-list');
        const contentTitle = document.getElementById('content-title');
        const contentBody = document.getElementById('content-body');
        const searchInput = document.getElementById('search-input');
        const linkContainer = document.getElementById('link-container');
        const contentLink = document.getElementById('content-link');
        const loadingIndicator = document.getElementById('loading-indicator');
        const aiFeatureSection = document.getElementById('ai-feature-section');
        const generateInsightBtn = document.getElementById('generate-insight-btn');
        const insightOutput = document.getElementById('insight-output');
        const insightText = document.getElementById('insight-text');
        const insightLoading = document.getElementById('insight-loading');

        // H√†m chuy·ªÉn ƒë·ªïi t·ª´ HSV sang RGB (gi√° tr·ªã 0-1 sang 0-255)
        function hsvToRgb(h, s, v) {
            let r, g, b;
            h = h % 1;
            if (s <= 0) { r = g = b = v; return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)]; }
            h *= 6;
            let i = Math.floor(h);
            let f = h - i;
            let p = v * (1 - s);
            let q = v * (1 - f * s);
            let t = v * (1 - (1 - f) * s);
            switch (i % 6) {
                case 0: r = v; g = t; b = p; break;
                case 1: r = q; g = v; b = p; break;
                case 2: r = p; g = v; b = t; break;
                case 3: r = p; g = q; b = v; break;
                case 4: r = t; g = p; b = v; break;
                case 5: r = v; g = p; b = q; break;
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        // ƒê·ªãnh nghƒ©a c√°c gi√° tr·ªã HSV cho c√°c m√†u (ƒë√£ ch·ªânh l·∫°i theo y√™u c·∫ßu anh Sea)
        const COLOR_HSV_VALUES = {
            'red': [0.00, 1.00, 1.00], // ƒê·ªè t∆∞∆°i
            'fire': [0.04, 1.00, 0.95],
            'orange': [0.09, 1.00, 0.95],
            'yellow': [0.15, 0.98, 0.95],

            // Xanh l√° ƒë·∫≠m h∆°n
            'lime': [0.20, 0.95, 0.40],
            'jade': [0.25, 0.95, 0.35],
            'green': [0.33, 0.95, 0.30],
            'aqua': [0.47, 0.90, 0.30],
            'cyan': [0.53, 0.95, 0.40],
            'navy': [0.56, 0.95, 0.50],
            'sea': [0.61, 0.95, 0.50],
            'blue': [0.64, 0.95, 0.45],
            'violet': [0.74, 0.90, 0.40],
            'purple': [0.80, 0.95, 0.40],
            'magenta': [0.86, 0.95, 0.35],
            'wine': [0.92, 0.95, 0.45],

            'black': [0.00, 0.00, 0.00], // Pure black
            'white': [0.00, 0.00, 1.00], // Pure white
        };

        // √Ånh x·∫° category sang t√™n m√†u t·ª´ COLOR_HSV_VALUES
        const TYPE_COLOR_MAPPING = {
            'help': 'yellow', 'org': 'fire', 'game': 'cyan', 'term': 'red',
            'setup': 'yellow', 'pattern': 'jade', 'command': 'navy',
            'english': 'blue', 'name': 'violet',
            '': 'special_group_color', // D√πng cho c√°c m·ª•c nh√≥m (keyword tr·ªëng)
            'default': 'gray', // Fallback n·∫øu category kh√¥ng kh·ªõp
        };

        // H√†m ƒë·ªÉ l·∫•y m√†u cho t·ª´ng category, lu√¥n ·ªü ch·∫ø ƒë·ªô dark mode
        function getCategoryColor(category) {
            const isDarkMode = true; // Lu√¥n l√† true v√¨ Dark Theme l√† m·∫∑c ƒë·ªãnh
            if (category === '') { // X·ª≠ l√Ω m√†u cho m·ª•c nh√≥m ri√™ng (m√†u tr·∫Øng tinh kh√¥i ho·∫∑c ƒëen)
                return 'rgb(255,255,255)'; // Lu√¥n l√† tr·∫Øng trong Dark Mode
            }

            const colorKey = TYPE_COLOR_MAPPING[category] || TYPE_COLOR_MAPPING['default'];
            let hsv = COLOR_HSV_VALUES[colorKey];
            if (hsv) {
                let [h, s, v] = hsv;
                // ƒêi·ªÅu ch·ªânh ƒë·ªô s√°ng (V) cho dark mode ƒë·ªÉ ƒë·∫£m b·∫£o t∆∞∆°ng ph·∫£n t·ªët
                if (isDarkMode) {
                    v = Math.max(v, 0.7); // ƒê·∫£m b·∫£o ƒë·ªô s√°ng t·ªëi thi·ªÉu l√† 0.7
                }
                const [r, g, b] = hsvToRgb(h, s, v);
                return `rgb(${r}, ${g}, ${b})`;
            }
            return 'inherit'; // Fallback
        }

        // --- Theme Logic ---
        // H√†m applyTheme ƒë√£ ƒë∆∞·ª£c ƒë∆°n gi·∫£n h√≥a ƒë·ªÉ ch·ªâ √°p d·ª•ng Dark Theme
        function applyTheme() {
            renderKeywords(currentFilteredAndOrderedData); // Re-render ƒë·ªÉ c·∫≠p nh·∫≠t m√†u s·∫Øc

            // Sau khi render l·∫°i keywords, hi·ªÉn th·ªã l·∫°i n·ªôi dung c·ªßa t·ª´ kh√≥a ƒëang ch·ªçn
            if (currentDisplayedKeyword) {
                displayContent(currentDisplayedKeyword);
            }
        }

        // Apply theme on initial load
        document.addEventListener('DOMContentLoaded', () => {
            // Lu√¥n √°p d·ª•ng Dark Theme khi t·∫£i trang
            document.documentElement.classList.add('dark'); // ƒê·∫£m b·∫£o class 'dark' c√≥ m·∫∑t
            applyTheme(); // G·ªçi applyTheme ƒë·ªÉ ƒë·∫£m b·∫£o c√°c m√†u s·∫Øc category v√† n·ªôi dung ƒë∆∞·ª£c c·∫≠p nh·∫≠t

            // Apply AI feature state based on the manual override
            if (!ENABLE_AI_MANUALLY_OVERRIDE) {
                aiFeatureSection.classList.add('hidden');
            } else {
                aiFeatureSection.classList.remove('hidden');
            }
        });
        // --- End Theme Logic ---


        // H√†m x·ª≠ l√Ω d·ªØ li·ªáu th√¥ sang ƒë·ªãnh d·∫°ng d·ªÖ d√πng
        function processRawData(data) {
            const processed = {};
            data.forEach((entry, index) => {
                const [name, keyword, category, content, link] = entry;
                // L·ªçc b·ªè c√°c m·ª•c c√≥ FNNS
                if ((content && (content.includes("{{FNNS:") || content.includes("{{FNNS|"))) ||
                    (name && (name.includes("{{FNNS:") || name.includes("{{FNNS|")))) {
                    return;
                }
                processed[keyword] = { name, keyword, category, content, link, originalIndex: index };
            });
            return processed;
        }

        // H√†m hi·ªÉn th·ªã n·ªôi dung chi ti·∫øt c·ªßa t·ª´ kh√≥a
        function displayContent(keyword) {
            // L∆∞u t·ª´ kh√≥a ƒëang hi·ªÉn th·ªã
            currentDisplayedKeyword = keyword; 

            if (selectedKeywordElement) {
                selectedKeywordElement.classList.remove('bg-green-100', 'text-green-800', 'font-bold', 'shadow-sm');
                selectedKeywordElement.style.color = getCategoryColor(processedDictionaryData[selectedKeywordElement.dataset.keyword]?.category || '');
            }

            currentDisplayedEntry = processedDictionaryData[keyword];
            linkContainer.classList.add('hidden');
            insightOutput.classList.add('hidden');
            generateInsightBtn.classList.add('hidden'); // Hide button by default

            if (currentDisplayedEntry) {
                contentTitle.textContent = currentDisplayedEntry.name;
                contentBody.innerHTML = `<p class="whitespace-pre-wrap">${currentDisplayedEntry.content}</p>`;
                if (currentDisplayedEntry.link) {
                    contentLink.href = currentDisplayedEntry.link;
                    linkContainer.classList.remove('hidden');
                }
                // Only show generate insight button if AI feature is manually enabled
                if (ENABLE_AI_MANUALLY_OVERRIDE) {
                    generateInsightBtn.classList.remove('hidden');
                }
            } else if (keyword === "Ch·∫øt d·ªü r·ªìi.....") {
                contentTitle.textContent = "T·ª´ ƒëi·ªÉn kh√¥ng th·ªÉ load üò≠";
                contentBody.innerHTML = "<p>Zictionary ch∆∞a t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu r·ªìi. C√≥ g√¨ ƒë√≥ sai sai chƒÉng?</p>";
            } else {
                contentTitle.textContent = `Kh√¥ng t√¨m th·∫•y t·ª´ kh√≥a`;
                contentBody.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y t·ª´ kh√≥a n√†o ph√π h·ª£p. N·∫øu b·∫°n mu·ªën xem l·∫°i m·ª•c l·ª•c, h√£y x√≥a √¥ t√¨m ki·∫øm v√† g√µ `mucluc`</p>";
            }

            const newSelectedElement = document.querySelector(`#keyword-list li[data-keyword="${keyword}"]`);
            if (newSelectedElement) {
                newSelectedElement.classList.add('bg-green-100', 'text-green-800', 'font-bold', 'shadow-sm');
                newSelectedElement.style.color = ''; // Reset color for active state (Tailwind default)
                selectedKeywordElement = newSelectedElement;
            }
        }

        // H√†m l·ªçc v√† s·∫Øp x·∫øp d·ªØ li·ªáu
        function filterAndOrderData(searchTerm) {
            const lowerSearchTerm = searchTerm.toLowerCase().trim();
            const exactNameMatches = [];
            const otherMatches = [];

            Object.values(processedDictionaryData).forEach(entry => {
                const lowerName = entry.name.toLowerCase();
                const lowerKeyword = entry.keyword.toLowerCase();

                // Rule: N·∫øu keyword tr·ªëng, kh√¥ng hi·ªÉn th·ªã trong k·∫øt qu·∫£ t√¨m ki·∫øm khi c√≥ search term
                if (entry.keyword.trim() === "" && lowerSearchTerm !== "") {
                    return;
                }

                if (lowerName === lowerSearchTerm) {
                    exactNameMatches.push(entry);
                } else if (lowerName.includes(lowerSearchTerm) || lowerKeyword.includes(lowerSearchTerm)) {
                    otherMatches.push(entry);
                }
            });

            exactNameMatches.sort((a, b) => a.originalIndex - b.originalIndex);
            otherMatches.sort((a, b) => a.originalIndex - b.originalIndex);

            currentFilteredAndOrderedData = [...exactNameMatches, ...otherMatches];
        }

        // H√†m render danh s√°ch t·ª´ kh√≥a
        function renderKeywords(dataToRender) {
            keywordListDiv.innerHTML = '';
            loadingIndicator.classList.add('hidden');

            if (Object.keys(processedDictionaryData).length === 0 && !isDictionaryLoadedSuccessfully) {
                const li = document.createElement('li');
                li.className = 'p-1.5 rounded-lg bg-red-100 text-red-700 font-bold cursor-pointer transition duration-200';
                li.textContent = '·ªêi d·ªìi √¥i';
                li.dataset.keyword = "·ªêi d·ªìi √¥i";
                li.addEventListener('click', () => displayContent("·ªêi d·ªìi √¥i"));
                keywordListDiv.appendChild(li);
                displayContent("·ªêi d·ªìi √¥i");
                return;
            }

            if (dataToRender.length === 0) {
                const noResultDiv = document.createElement('div');
                noResultDiv.className = 'p-1.5 rounded-lg text-gray-500 italic';
                noResultDiv.innerHTML = 'Kh√¥ng t√¨m th·∫•y t·ª´ kh√≥a n√†o ph√π h·ª£p. N·∫øu b·∫°n mu·ªën xem l·∫°i m·ª•c l·ª•c, h√£y x√≥a √¥ t√¨m ki·∫øm v√† g√µ `mucluc`';
                keywordListDiv.appendChild(noResultDiv);
                displayContent('');
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'space-y-0.5';
            dataToRender.forEach(entry => {
                const li = document.createElement('li');
                li.className = 'p-1 rounded-md hover:bg-green-100 cursor-pointer transition duration-200 text-sm font-medium active:bg-green-200';
                li.textContent = entry.name;
                li.dataset.keyword = entry.keyword;
                li.style.color = getCategoryColor(entry.category);
                li.addEventListener('click', () => displayContent(entry.keyword));
                ul.appendChild(li);
            });
            keywordListDiv.appendChild(ul);

            // Ch·ªâ hi·ªÉn th·ªã n·ªôi dung c·ªßa t·ª´ kh√≥a ƒë·∫ßu ti√™n n·∫øu ch∆∞a c√≥ t·ª´ kh√≥a n√†o ƒë∆∞·ª£c ch·ªçn tr∆∞·ªõc ƒë√≥
            // ho·∫∑c n·∫øu danh s√°ch t·ª´ kh√≥a ƒë∆∞·ª£c render l·∫°i v√† t·ª´ kh√≥a hi·ªán t·∫°i kh√¥ng c√≤n trong danh s√°ch.
            if (!currentDisplayedKeyword || !dataToRender.some(entry => entry.keyword === currentDisplayedKeyword)) {
                if (dataToRender.length > 0) {
                    displayContent(dataToRender[0].keyword);
                } else {
                    displayContent('');
                }
            }
        }

        // H√†m t·∫£i d·ªØ li·ªáu t·ª´ ƒëi·ªÉn
        async function loadDictionaryData() {
            try {
                loadingIndicator.classList.remove('hidden');
                const response = await fetch(DICTIONARY_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const rawData = await response.json();
                processedDictionaryData = processRawData(rawData);
                isDictionaryLoadedSuccessfully = true;
                filterAndOrderData("");
                renderKeywords(currentFilteredAndOrderedData);
            } catch (error) {
                console.error("L·ªói khi t·∫£i t·ª´ ƒëi·ªÉn:", error);
                isDictionaryLoadedSuccessfully = false;
                // ƒê·ªïi th√¥ng b√°o l·ªói cho ph√π h·ª£p v·ªõi Dark Theme
                displayContent("Ch·∫øt d·ªü r·ªìi....."); 
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // --- Gemini API Integration ---
        generateInsightBtn.addEventListener('click', async () => {
            // Check if AI feature is enabled via the manual override flag
            if (!ENABLE_AI_MANUALLY_OVERRIDE) {
                insightText.textContent = "T√≠nh nƒÉng AI hi·ªán ƒëang t·∫Øt.";
                insightOutput.classList.remove('hidden');
                return;
            }
            if (!currentDisplayedEntry) {
                insightText.textContent = "Vui l√≤ng ch·ªçn m·ªôt t·ª´ kh√≥a ƒë·ªÉ t·∫°o th√¥ng tin m·ªü r·ªông.";
                insightOutput.classList.remove('hidden');
                return;
            }

            insightOutput.classList.remove('hidden');
            insightText.textContent = "";
            insightLoading.classList.remove('hidden');
            generateInsightBtn.disabled = true;

            const termName = currentDisplayedEntry.name;
            const termDefinition = currentDisplayedEntry.content;

            const prompt = `D·ª±a v√†o thu·∫≠t ng·ªØ '${termName}' v√† ƒë·ªãnh nghƒ©a c·ªßa n√≥: '${termDefinition}', h√£y cung c·∫•p m·ªôt ƒëo·∫°n vƒÉn ng·∫Øn (t·ªëi ƒëa 3 c√¢u) v·ªÅ m·ªôt th√¥ng tin th√∫ v·ªã, m·ªôt ·ª©ng d·ª•ng th·ª±c t·∫ø, ho·∫∑c m·ªôt b·ªëi c·∫£nh r·ªông h∆°n li√™n quan ƒë·∫øn thu·∫≠t ng·ªØ n√†y trong lƒ©nh v·ª±c game x·∫øp g·∫°ch ho·∫∑c c√¥ng ngh·ªá n√≥i chung. ƒê·ª´ng ch·ªâ di·ªÖn gi·∫£i l·∫°i ƒë·ªãnh nghƒ©a. Tr·∫£ l·ªùi b·∫±ng ti·∫øng Vi·ªát.`;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will automatically provide it at runtime
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    insightText.textContent = text;
                } else {
                    insightText.textContent = "R·∫•t ti·∫øc, kh√¥ng th·ªÉ t·∫°o th√¥ng tin m·ªü r·ªông l√∫c n√†y. Vui l√≤ng th·ª≠ l·∫°i sau.";
                    console.error("Gemini API response format unexpected:", result);
                }
            } catch (error) {
                insightText.textContent = "ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi v·ªõi Gemini API. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.";
                console.error("L·ªói khi g·ªçi Gemini API:", error);
            } finally {
                insightLoading.classList.add('hidden');
                generateInsightBtn.disabled = false;
            }
        });
        // --- End Gemini API Integration ---

        // X·ª≠ l√Ω s·ª± ki·ªán t√¨m ki·∫øm
        searchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value;
            filterAndOrderData(searchTerm);
            renderKeywords(currentFilteredAndOrderedData);
        });

        // Kh·ªüi t·∫°o Zictionary khi t·∫£i trang
        document.addEventListener('DOMContentLoaded', loadDictionaryData);
    </script>
</body>
</html>
